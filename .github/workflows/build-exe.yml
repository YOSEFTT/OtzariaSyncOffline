name: Build otzaria_sync_offline.exe
permissions:
  contents: write
  
on:
  workflow_dispatch:
    inputs:
      icon_path:
        description: '× ×ª×™×‘ ×œ××™×™×§×•×Ÿ ×‘×ª×•×š ×”×¨×™×¤×• (rel path). ×“×•×’××”: build/sync_otzaria.ico'
        required: false
        default: 'build/sync_otzaria.ico'
      python_version:
        description: '×’×¨×¡×ª ×¤×™×™×ª×•×Ÿ ×œ×©×™××•×© ×‘Ö¾runner'
        required: false
        default: '3.10.6'
      release_create:
        description: 'Create GitHub Release after successful build? (true/false)'
        required: false
        default: 'true'
      release_tag:
        description: 'Tag for the release â€” ×™×© ×œ××œ× ×™×“× ×™×ª (×œ×“×•×’××”: v2.5.0)'
        required: true
        default: ''
      release_name:
        description: 'Release name (optional)'
        required: false
        default: ''

jobs:
  build-windows:
    name: Build (Windows)
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ inputs.python_version }}

      - name: Install Python dependencies
        shell: pwsh
        run: |
          python -m pip install --upgrade pip setuptools wheel
          if (Test-Path -Path "requirements.txt") {
            Write-Host "Found requirements.txt â€” installing..."
            pip install -r requirements.txt
          } else {
            Write-Host "requirements.txt not found in repo root â€” continuing without it."
          }

          # ×”×ª×§× ×ª PyInstaller (×•×¢×“×›×•× ×™× ×œ×©×¢×ª build)
          pip install pyinstaller pyinstaller-hooks-contrib

      - name: Prepare certificate from secret or repo (optional)
        id: prepare_pfx
        shell: pwsh
        run: |
          Write-Host "Looking for certificate.pfx in repo root..."
          if (Test-Path certificate.pfx) {
            Write-Host "Found certificate.pfx in repository root."
            echo "have_pfx=true" >> $GITHUB_OUTPUT
          } elseif ($env:PFX_BASE64 -and $env:PFX_BASE64 -ne '') {
            Write-Host "Decoding PFX from secret PFX_BASE64 -> certificate.pfx"
            [IO.File]::WriteAllBytes('certificate.pfx', [Convert]::FromBase64String($env:PFX_BASE64))
            if (Test-Path certificate.pfx) {
              Write-Host "PFX written to certificate.pfx"
              echo "have_pfx=true" >> $GITHUB_OUTPUT
            } else {
              Write-Host "Failed to write certificate.pfx from secret"
              echo "have_pfx=false" >> $GITHUB_OUTPUT
            }
          } else {
            Write-Host "No PFX found in repo and PFX_BASE64 secret empty."
            echo "have_pfx=false" >> $GITHUB_OUTPUT
          }
        env:
          PFX_BASE64: ${{ secrets.PFX_BASE64 }}

      - name: Build EXE with PyInstaller
        shell: pwsh
        env:
          ICON_PATH: ${{ inputs.icon_path }}
        run: |
          $script = 'otzaria_sync_offline.py'
          if (-not (Test-Path $script)) {
            Write-Error "Script '$script' not found in repository root. Ensure file is in repo root or update workflow."
            exit 1
          }

          $icon = "${{ inputs.icon_path }}"

          $pyinstallerArgs = @(
            "--noconfirm"
            "--onefile"
            "--windowed"
            "--clean"
          )

          if (Test-Path $icon) {
            $pyinstallerArgs += "--icon"
            $pyinstallerArgs += $icon
          } else {
            Write-Host "Icon not found at: $icon  (continuing without icon)"
          }

          $pyinstallerArgs += $script
          Write-Host "Running: pyinstaller $($pyinstallerArgs -join ' ')"

          # show files to help debugging
          Write-Host "ğŸ“ Files in current directory (top-level):"
          Get-ChildItem | Select-Object Name

          pyinstaller @pyinstallerArgs

      - name: Sign EXE (signtool) â€” if certificate available
        if: ${{ steps.prepare_pfx.outputs.have_pfx == 'true' }}
        shell: pwsh
        run: |
          $exePath = Join-Path $PWD 'dist\otzaria_sync_offline.exe'
          if (-not (Test-Path $exePath)) {
            Write-Host "No built EXE found at $exePath â€” skipping signing."
            exit 0
          }

          $pfx = Join-Path $PWD 'certificate.pfx'
          if (-not (Test-Path $pfx)) {
            Write-Host "certificate.pfx not found where expected ($pfx) â€” skipping signing."
            exit 1
          }

          if ($env:PFX_PASSWORD -and $env:PFX_PASSWORD -ne '') {
            $pfxPasswordArg = "/p `"$env:PFX_PASSWORD`""
          } else {
            $pfxPasswordArg = ""
            Write-Host "PFX_PASSWORD secret empty â€” attempting to sign without password (may fail)."
          }

          $timestamp = "http://timestamp.digicert.com"
          Write-Host "Signing $exePath using $pfx"
          signtool sign /f "`"$pfx`"" $pfxPasswordArg /fd SHA256 /v /a /t $timestamp "`"$exePath`""
          if ($LASTEXITCODE -ne 0) {
            Write-Host "signtool failed with exit code $LASTEXITCODE"
            exit $LASTEXITCODE
          } else {
            Write-Host "Signing completed."
          }
        env:
          PFX_PASSWORD: ${{ secrets.PFX_PASSWORD }}

      - name: Upload EXE artifact
        uses: actions/upload-artifact@v4
        with:
          name: otzaria_sync_offline.exe
          path: dist/otzaria_sync_offline.exe

  release:
    name: Publish Release
    runs-on: ubuntu-latest
    needs: build-windows
    if: ${{ github.event.inputs.release_create != 'false' && needs.build-windows.result == 'success' }}
    steps:
      - name: Checkout repository (to read repository if needed)
        uses: actions/checkout@v4

      - name: Download EXE artifact
        uses: actions/download-artifact@v4
        with:
          name: otzaria_sync_offline.exe
          path: ./dist

      - name: Validate release_tag input
        run: |
          # ×©×™××• ×œ×‘: ××©×ª××©×™× ×‘Ö¾single quotes ×¡×‘×™×‘ ×”×‘×™×˜×•×™ ×›×“×™ ×œ×”×™×× ×¢ ××‘×¢×™×•×ª ×¦×™×˜×•×˜
          if [ -z '${{ github.event.inputs.release_tag }}' ]; then
            echo "release_tag input is empty â€” ×™×© ×œ××œ× ××ª release_tag ×‘×¢×ª ×”×¨×¦×ª ×”Ö¾workflow"
            exit 1
          fi

      - name: Create GitHub Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.event.inputs.release_tag }}
          release_name: ${{ github.event.inputs.release_name && github.event.inputs.release_name || format('otzaria_sync_offline {0}', github.event.inputs.release_tag) }}
          draft: false
          prerelease: false

      - name: Upload EXE to Release
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./dist/otzaria_sync_offline.exe
          asset_name: otzaria_sync_offline.exe
          asset_content_type: application/octet-stream
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
