name: Build otzaria_sync_offline.exe

on:
  workflow_dispatch:
    inputs:
      icon_path:
        description: 'נתיב לאייקון בתוך הריפו (rel path). דוגמה: build/sync_otzaria.ico'
        required: false
        default: 'build/sync_otzaria.ico'
      version_file:
        description: 'נתיב ל־version file בתוך הריפו (rel path). דוגמה: version_info'
        required: false
        default: 'version_info'
      python_version:
        description: 'גרסת פייתון לשימוש ב־runner'
        required: false
        default: '3.10.6'
      release_create:
        description: 'Create GitHub Release after successful build? (true/false)'
        required: false
        default: 'true'
      release_tag:
        description: 'Tag for the release (optional). אם ריק -> ייקרא מהקובץ version_file'
        required: false
        default: ''
      release_name:
        description: 'Release name (optional)'
        required: false
        default: ''

jobs:
  build-windows:
    name: Build (Windows)
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ inputs.python_version }}

      - name: Install Python dependencies
        shell: pwsh
        run: |
          python -m pip install --upgrade pip setuptools wheel
          if (Test-Path -Path "requirements.txt") {
            Write-Host "Found requirements.txt — installing..."
            pip install -r requirements.txt
          } else {
            Write-Host "requirements.txt not found in repo root — continuing without it."
          }

          # התקנת PyInstaller (ועדכונים לשעת build)
          pip install pyinstaller pyinstaller-hooks-contrib
       

      - name: Prepare certificate from secret or repo (optional)
        id: prepare_pfx
        shell: pwsh
        run: |
          Write-Host "Looking for certificate.pfx in repo root..."
          if (Test-Path certificate.pfx) {
            Write-Host "Found certificate.pfx in repository root."
            echo "have_pfx=true" >> $GITHUB_OUTPUT
          } elseif ($env:PFX_BASE64 -and $env:PFX_BASE64 -ne '') {
            Write-Host "Decoding PFX from secret PFX_BASE64 -> certificate.pfx"
            [IO.File]::WriteAllBytes('certificate.pfx', [Convert]::FromBase64String($env:PFX_BASE64))
            if (Test-Path certificate.pfx) {
              Write-Host "PFX written to certificate.pfx"
              echo "have_pfx=true" >> $GITHUB_OUTPUT
            } else {
              Write-Host "Failed to write certificate.pfx from secret"
              echo "have_pfx=false" >> $GITHUB_OUTPUT
            }
          } else {
            Write-Host "No PFX found in repo and PFX_BASE64 secret empty."
            echo "have_pfx=false" >> $GITHUB_OUTPUT
          }
        env:
          PFX_BASE64: ${{ secrets.PFX_BASE64 }}


      - name: Build EXE with PyInstaller
        shell: pwsh
        env:
          ICON_PATH: ${{ inputs.icon_path }}
          VERSION_FILE: ${{ inputs.version_file }}
        run: |
          $script = 'otzaria_sync_offline.py'
          if (-not (Test-Path $script)) {
            Write-Error "Script '$script' not found in repository root. Ensure file is in repo root or update workflow."
            exit 1
          }
      
          $icon = "${{ inputs.icon_path }}"
          $version = "${{ inputs.version_file }}"
      
          $pyinstallerArgs = @(
            "--noconfirm"
            "--onefile"
            "--windowed"
            "--clean"
          )
      
          if (Test-Path $icon) {
            $pyinstallerArgs += "--icon"
            $pyinstallerArgs += $icon
          } else {
            Write-Host "Icon not found at: $icon  (continuing without icon)"
          }
      
          if (Test-Path $version) {
            $pyinstallerArgs += "--version-file"
            $pyinstallerArgs += $version
          } else {
            Write-Host "Version file not found at: $version  (continuing without version-file)"
          }
      
          $pyinstallerArgs += $script
          Write-Host "Running: pyinstaller $($pyinstallerArgs -join ' ')"
          pyinstaller @pyinstallerArgs

      - name: Sign EXE (signtool) — if certificate available
        if: ${{ steps.prepare_pfx.outputs.have_pfx == 'true' }}
        shell: pwsh
        run: |
          $exePath = Join-Path $PWD 'dist\otzaria_sync_offline.exe'
          if (-not (Test-Path $exePath)) {
            Write-Host "No built EXE found at $exePath — skipping signing."
            exit 0
          }

          $pfx = Join-Path $PWD 'certificate.pfx'
          if (-not (Test-Path $pfx)) {
            Write-Host "certificate.pfx not found where expected ($pfx) — skipping signing."
            exit 1
          }

          if ($env:PFX_PASSWORD -and $env:PFX_PASSWORD -ne '') {
            $pfxPasswordArg = "/p `"$env:PFX_PASSWORD`""
          } else {
            $pfxPasswordArg = ""
            Write-Host "PFX_PASSWORD secret empty — attempting to sign without password (may fail)."
          }

          $timestamp = "http://timestamp.digicert.com"
          Write-Host "Signing $exePath using $pfx"
          signtool sign /f "`"$pfx`"" $pfxPasswordArg /fd SHA256 /v /a /t $timestamp "`"$exePath`""
          if ($LASTEXITCODE -ne 0) {
            Write-Host "signtool failed with exit code $LASTEXITCODE"
            exit $LASTEXITCODE
          } else {
            Write-Host "Signing completed."
          }
        env:
          PFX_PASSWORD: ${{ secrets.PFX_PASSWORD }}

      - name: Upload EXE artifact
        uses: actions/upload-artifact@v4
        with:
          name: otzaria_sync_offline.exe
          path: dist/otzaria_sync_offline.exe

  release:
    name: Publish Release
    runs-on: ubuntu-latest
    needs: build-windows
    if: ${{ github.event.inputs.release_create != 'false' && needs.build-windows.result == 'success' }}
    steps:
      - name: Checkout repository (to read version file)
        uses: actions/checkout@v4

      - name: Download EXE artifact
        uses: actions/download-artifact@v4
        with:
          name: otzaria_sync_offline.exe
          path: ./dist

      - name: Determine release tag (from input or from version file) — no Python
        id: determine_tag
        run: |
          # אם סיפקת release_tag נשתמש בו
          if [ -n "${{ github.event.inputs.release_tag }}" ]; then
            TAG="${{ github.event.inputs.release_tag }}"
            echo "Using provided release_tag: $TAG"
          else
            VF="${{ github.event.inputs.version_file }}"
            echo "Attempting to read version from file: $VF"

            if [ -f "$VF" ]; then
              # נסה קודם לחלץ ProductVersion / FileVersion מתוך StringStruct
              VERSION=$(perl -0777 -ne '
                if ( m{StringStruct\(\s*u?[\'"](?:ProductVersion|FileVersion)[\'"]\s*,\s*u?[\'"]([^\'"]+)[\'"]}i ) {
                  print $1 and exit;
                }
                if ( m{filevers\s*=\s*\(\s*([0-9]+)\s*,\s*([0-9]+)\s*,\s*([0-9]+)\s*,\s*([0-9]+)\s*\)}i ) {
                  print "$1.$2.$3.$4" and exit;
                }
              ' "$VF" 2>/dev/null || true)

              # Trim whitespace
              VERSION="$(echo "$VERSION" | tr -d '\r\n' )"
              VERSION="$(echo "$VERSION" | tr -d '"' )"
              echo "✅ Version after cleanup: '$VERSION'"

              if [ -n "$VERSION" ]; then
                # ודא שיש קידומת v
                case "$VERSION" in
                  v*) TAG="$VERSION" ;;
                  *)  TAG="v$VERSION" ;;
                esac
                echo "Extracted version: $TAG"
              else
                echo "Could not extract version from $VF; falling back to run number tag"
                TAG="v${GITHUB_RUN_NUMBER}"
              fi
            else
              echo "Version file $VF not found; falling back to run number tag"
              TAG="v${GITHUB_RUN_NUMBER}"
            fi
          fi

          # set outputs
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          if [ -n "${{ github.event.inputs.release_name }}" ]; then
            echo "name=${{ github.event.inputs.release_name }}" >> $GITHUB_OUTPUT
          else
            echo "name=otzaria_sync_offline ${TAG}" >> $GITHUB_OUTPUT
          fi

      - name: Create GitHub Release
        id: create_release
        uses: actions/create-release@v1
        with:
          tag_name: ${{ steps.determine_tag.outputs.tag }}
          release_name: ${{ steps.determine_tag.outputs.name }}
          draft: false
          prerelease: false
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload EXE to Release
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./dist/otzaria_sync_offline.exe
          asset_name: otzaria_sync_offline.exe
          asset_content_type: application/octet-stream
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
